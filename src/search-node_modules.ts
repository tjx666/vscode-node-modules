import { basename, dirname, join } from 'path';
import { Uri, window, workspace } from 'vscode';

import { NODE_MODULES } from './types';
import t from './utils/localize';
import showPickWorkspaceFolder from './vs-utils/showPickWorkspaceFolder';
import showQuickPickFile from './vs-utils/showQuickPickFile';

export default async function (uri: Uri) {
  let node_modulesPath = uri ? uri.path : ''
  if (!node_modulesPath) {
    let projectRootPath
    try {
      projectRootPath = await showPickWorkspaceFolder()
      if (!projectRootPath) {
        window.showErrorMessage(t('tip.selectSearchProject'))
        return
      }
    } catch (error: any) {
      projectRootPath = ''
      window.showErrorMessage(t('tip.workspaceNoOpenProject'))
      return
    }
    node_modulesPath = join(projectRootPath, NODE_MODULES)
  }
  const filePath = await showQuickPickFile(
    node_modulesPath,
    join(basename(dirname(node_modulesPath)), NODE_MODULES)
  )
  filePath && workspace.openTextDocument(filePath).then(window.showTextDocument)
}
